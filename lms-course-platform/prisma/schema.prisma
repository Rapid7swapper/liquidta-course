generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model certificates {
  id             String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  enrollment_id  String      @unique @db.Uuid
  certificate_id String      @unique @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  issued_at      DateTime    @default(now()) @db.Timestamptz(6)
  enrollments    enrollments @relation(fields: [enrollment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model courses {
  id           String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title        String
  description  String?
  image_url    String?
  is_published Boolean       @default(false)
  created_at   DateTime      @default(now()) @db.Timestamptz(6)
  updated_at   DateTime      @default(now()) @db.Timestamptz(6)
  enrollments  enrollments[]
  modules      modules[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model enrollments {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id         String
  course_id       String            @db.Uuid
  organization_id String?           @db.Uuid
  enrolled_at     DateTime          @default(now()) @db.Timestamptz(6)
  completed_at    DateTime?         @db.Timestamptz(6)
  certificates    certificates?
  courses         courses           @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organizations   organizations?    @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  lesson_progress lesson_progress[]

  @@unique([user_id, course_id])
  @@index([course_id], map: "idx_enrollments_course_id")
  @@index([organization_id], map: "idx_enrollments_organization_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model lesson_progress {
  id              String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  lesson_id       String      @db.Uuid
  enrollment_id   String      @db.Uuid
  is_completed    Boolean     @default(false)
  watched_seconds Int         @default(0)
  total_seconds   Int         @default(0)
  completed_at    DateTime?   @db.Timestamptz(6)
  updated_at      DateTime    @default(now()) @db.Timestamptz(6)
  enrollments     enrollments @relation(fields: [enrollment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lessons         lessons     @relation(fields: [lesson_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([lesson_id, enrollment_id])
  @@index([enrollment_id], map: "idx_lesson_progress_enrollment_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model lessons {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title           String
  description     String?
  video_url       String?
  position        Int
  is_published    Boolean           @default(false)
  is_free         Boolean           @default(false)
  module_id       String            @db.Uuid
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  lesson_progress lesson_progress[]
  modules         modules           @relation(fields: [module_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  resources       resources[]

  @@index([module_id], map: "idx_lessons_module_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model modules {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title        String
  description  String?
  position     Int
  is_published Boolean   @default(false)
  course_id    String    @db.Uuid
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @default(now()) @db.Timestamptz(6)
  lessons      lessons[]
  courses      courses   @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  quizzes      quizzes?

  @@index([course_id], map: "idx_modules_course_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model organization_members {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String        @db.Uuid
  user_id         String
  role            member_role   @default(employee)
  created_at      DateTime      @default(now()) @db.Timestamptz(6)
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organization_id, user_id])
  @@index([user_id], map: "idx_organization_members_user_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model organizations {
  id                   String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                 String
  slug                 String                 @unique
  logo                 String?
  created_at           DateTime               @default(now()) @db.Timestamptz(6)
  updated_at           DateTime               @default(now()) @db.Timestamptz(6)
  enrollments          enrollments[]
  organization_members organization_members[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model question_options {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  question_id String    @db.Uuid
  text        String
  is_correct  Boolean   @default(false)
  position    Int
  questions   questions @relation(fields: [question_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([question_id], map: "idx_question_options_question_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model questions {
  id               String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quiz_id          String             @db.Uuid
  text             String
  type             question_type
  position         Int
  points           Int                @default(1)
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  question_options question_options[]
  quizzes          quizzes            @relation(fields: [quiz_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([quiz_id], map: "idx_questions_quiz_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model quiz_attempts {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quiz_id      String    @db.Uuid
  user_id      String
  score        Int
  passed       Boolean
  answers      Json
  started_at   DateTime  @default(now()) @db.Timestamptz(6)
  completed_at DateTime? @db.Timestamptz(6)
  quizzes      quizzes   @relation(fields: [quiz_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([quiz_id], map: "idx_quiz_attempts_quiz_id")
  @@index([user_id], map: "idx_quiz_attempts_user_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model quizzes {
  id                 String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  module_id          String          @unique @db.Uuid
  passing_score      Int             @default(80)
  max_attempts       Int?
  time_limit_minutes Int?
  created_at         DateTime        @default(now()) @db.Timestamptz(6)
  updated_at         DateTime        @default(now()) @db.Timestamptz(6)
  questions          questions[]
  quiz_attempts      quiz_attempts[]
  modules            modules         @relation(fields: [module_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model resources {
  id         String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name       String
  url        String
  type       resource_type
  lesson_id  String        @db.Uuid
  created_at DateTime      @default(now()) @db.Timestamptz(6)
  lessons    lessons       @relation(fields: [lesson_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([lesson_id], map: "idx_resources_lesson_id")
}

model users {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clerk_id    String?   @unique
  email       String    @unique
  first_name  String
  last_name   String
  role        user_role @default(student)
  created_by  String?   @db.Uuid
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)
  users       users?    @relation("usersTousers", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_users users[]   @relation("usersTousers")

  @@index([clerk_id], map: "idx_users_clerk_id")
  @@index([created_by], map: "idx_users_created_by")
  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
}

enum member_role {
  owner
  admin
  employee
}

enum question_type {
  multiple_choice
  true_false
  multiple_select
}

enum resource_type {
  pdf
  video
  link
  file
}

enum user_role {
  student
  admin
  super_admin
}
